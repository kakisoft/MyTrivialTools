<!DOCTYPE html>
<html lang="ja">
  <head>
      <meta charset="utf8">
      <title>SQL Formatter</title>
  </head>
<body>
<h1 style="font-size: 1.5em">select文を整形したい的な何か</h1>
<div>
  <textarea id="target_syntax" style="width:60%; height:10em" placeholder="Please input any Select Statement."></textarea>
</div>

<p>
  <button type="button" id="format_SelectStatement">Format SelectStatement</button>
</p>
<p>
  <textarea id="result_syntax" style="width:60%; height:10em" ></textarea>
</p>

<script>

NEW_LINE_CHARACTER = "\n";
DIFINED_PHRASE_LIST = ["SELECT","FROM","WHERE","ORDER BY","GROUP BY","HAVING"];
DIFINED_SUB_PHRASE_LIST = [
  "AS", "LEFT", "RIGHT", "JOIN", "ORTER", "INNER", "ON", "AND",
  "SUM", "MAX"
];
RESERVED_WORD_LIST = 
[
  "SELECT","AS", "FROM", "LEFT", "RIGHT", "JOIN", "ORTER", "INNER", "ON", 
  "WHERE", "AND", "GROUP", "ORDER", "BY",
  "SUM", "MAX"
];

// SELECT_PREFIX = "   ,";
PREFIX_SPACE_COUNT = 4;

targetSyntaxElement = document.getElementById("target_syntax");
resultSyntaxElement = document.getElementById("result_syntax");

document.getElementById("format_SelectStatement").addEventListener("click", formatSelectStatement)

//=================================================================
//----------------------
//   For Develop Code
//----------------------
var forDev1 = `
select               
    T1.TABLE1.PROD_NO,
sum(decode(T2.CATEGORY,'1',T1.SALES                 ,0              ))  as  SALES,
	sum(decode(T2.CATEGORY,'2',round(T1.PAYMENT / 1.08 ), T1.PAYMENT))  as  PAYMENT,
		sum(t1.nm1)
,max(t2.mm1)
from              
    TABLE1  AS T1           
    left join TABLE2 T2 on T1.CATEGORY_CD = T2.CATEGORY_CD
where  1=1
  and  T1.COLUMN1 = 'CD'
group by
    T1.PROD_NO
Order   by
T1.PROD_NO
`
// ※ 途中で「--」のコメントを挟む構文は未対応。

document.getElementById("target_syntax").innerHTML = forDev1;

//=================================================================

// var selectContentArray  = [];
// var fromContentArray    = [];
// var whereContentArray   = [];
// var groupByContentArray = [];
// var orderByContentArray = [];
// var havingContentArray  = [];




//------------------------------
//      
//
// 予約語は大文字化されている前提で動いてます。
//
// ＜後で修正する点＞
// SELECT col1, (SELECT id FROM XXX)
// といったケースは未対応です。
// 副問い合わせは未対応です。
//------------------------------
function formatSelectContent(selectContentArray, unitArray){
  // var selectPosition = unitArray.indexOf("SELECT");
  // var fromPosition   = unitArray.indexOf("FROM");

  // var tmpArray = unitArray.slice(selectPosition + 1, fromPosition);

// console.log(tmpArray);

// , は削除。
// ・・・ではなく、(,)を削除
// ・・・でもなく、() 内は、ひとつの塊として扱う。
// AS句 


  return true;
}





// resultSyntaxElement.textContent = tmp
// console.log(unitArray)




//------------------------------
//      
//------------------------------
function setPrimitivePhraseSet(primitivePhraseSetArray, unitArray){

  // primitivePhraseSetArray['selectContentArray'] = [1,2,3]
  primitivePhraseSetArray['selectContentArray'] = getPrimitiveSelectPhrase(unitArray);

  // return true;
}

function getPrimitiveSelectPhrase(unitArray){
  var resultArray = []

  // console.log(unitArray)
  var selectPosition = unitArray.indexOf("SELECT");
  var fromPosition   = unitArray.indexOf("FROM");
// console.log(selectPosition)
  var tmpArray = unitArray.slice(selectPosition +1, fromPosition);

// console.log(tmpArray);


  resultArray = [1,2,3,4,5]

  return resultArray;
}





//======================================
//      Format SelectStatement
//======================================
function formatSelectStatement(){
  var targetSyntaxContent = targetSyntaxElement.value;
  var resultContent = "";

  resultSyntaxElement.textContent = ""


  //-----< Sqlstatoment To UnitArray >-----
  var unitArray = [];
  var resultSyntaxContentArray = [];
  sqlstatomentToUnitArray(unitArray, targetSyntaxContent);


  //-----< Capitalize Reserved Words >-----
  capitalizeReservedWords(unitArray, RESERVED_WORD_LIST);


  //-----< Bundle MultiConfigurationPhrase >-----
  bundleMultiConfigurationPhrase(unitArray);
console.log(unitArray)

  //-----< discriptionXXXXXXXX >-----
  var primitivePhraseSetArray = [];
  primitivePhraseSetArray['selectContentArray']  = [];
  primitivePhraseSetArray['fromContentArray']    = [];
  primitivePhraseSetArray['whereContentArray']   = [];
  primitivePhraseSetArray['groupByContentArray'] = [];
  primitivePhraseSetArray['orderByContentArray'] = [];
  primitivePhraseSetArray['havingContentArray']  = [];

// var selectContentArray  = [];
// var fromContentArray    = [];
// var whereContentArray   = [];
// var groupByContentArray = [];
// var orderByContentArray = [];
// var havingContentArray  = [];

  setPrimitivePhraseSet(primitivePhraseSetArray, unitArray);
// console.log(primitivePhraseSetArray['selectContentArray']);


  //-----< discriptionXXXXXXXX >-----
  var selectContentArray = [];
  formatSelectContent(selectContentArray, unitArray);



  // resultContent = targetSyntaxContent;






  // //-----< Set Result Contents >-----
  // setResultContents(resultContentArray, resultChunkSet);

  //-----< Output Result >-----
  // resultSyntaxElement.textContent = resultContent;

}

//=======================================================================================================
//=======================================================================================================

//------------------------------------
// Sqlstatoment To UnitArray
//
// Split into syntax units
//
// ＜後で修正する点＞
// スペースを全部カットする処理を入れているので、
//  param1 = 'a   b'
// といった内容があると、意図通りに動きません。
//------------------------------------
function sqlstatomentToUnitArray(unitArray, targetSyntaxContent){

  var tmp = targetSyntaxContent.trim();
  tmp = tmp.replace(/\t/g, " ");     // Replace tabs with spaces
  tmp = tmp.replace(/\r?\n/g, " ");  // Replace newlines with spaces
  tmp = tmp.replace(/\s+/g, " ");    // Replace one or more spaces by one space 

  tmpArray = tmp.split(/\s/g);

  unitArray.length = 0;
  Array.prototype.push.apply(unitArray, tmpArray);

  return;
}

//------------------------------------
//  Bundle MultiConfigurationPhrase
//------------------------------------
function bundleMultiConfigurationPhrase(unitArray){
  var pair1 = ["GROUP","BY"]  // => Change to ["GROUP BY"]
  var pair2 = ["ORDER","BY"]  // => Change to ["ORDER BY"]

  var tmpArray = unitArray;
  tmpArray = getBundledTwoPairArray(tmpArray, pair1);
  tmpArray = getBundledTwoPairArray(tmpArray, pair2);

  unitArray.length = 0;
  Array.prototype.push.apply(unitArray, tmpArray);

  return true;
}


//------------------------------------
//         Set ResultChunkSet
//------------------------------------
function setResultChunkSet(resultChunkSet, targetSyntaxContent){

  return true;
}

//------------------------------------
//          Set Result Contents
//------------------------------------
function setResultContents(resultContentArray, resultChunkSet){


  return;
}


//=======================================================================================================
//=======================================================================================================

</script>
<script src="./utils/KakiUtils.js"></script>
</body>
</html>